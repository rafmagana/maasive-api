<!DOCTYPE html><html lang="en"><head><title>server</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="server"><meta name="groc-project-path" content="server.js"><meta name="groc-github-url" content="https://github.com/elc/maasive-api"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/elc/maasive-api/blob/master/server.js">server.js</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="server-cluster">Server (Cluster)</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="requires">Requires</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Require environment-specific configuration</p></div></div><div class="code"><div class="wrapper"><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./env&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">cluster</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">oldUmask</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">umask</span><span class="p">(</span><span class="mi">0000</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The actual application</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./app&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="cluster">Cluster</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Configure the cluster</p></div></div><div class="code"><div class="wrapper"><span class="nx">cluster</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;workers&#39;</span><span class="p">,</span> <span class="nx">API</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">workers</span> <span class="o">||</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;socket path&#39;</span><span class="p">,</span> <span class="nx">API</span><span class="p">.</span><span class="nx">config</span><span class="p">[</span><span class="s1">&#39;socket path&#39;</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="nx">API</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">server_user</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Define middlewares</p></div></div><div class="code"><div class="wrapper">  <span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">](</span><span class="s1">&#39;development&#39;</span><span class="p">)</span>
  <span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">](</span><span class="s1">&#39;staging&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">debug</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">pidfiles</span><span class="p">())</span>
  <span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">](</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">listening_to</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Listening to &#39;</span><span class="p">.</span><span class="nx">grey</span> <span class="o">+</span> <span class="nx">global</span><span class="p">.</span><span class="nx">listening_to</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">blue</span><span class="p">);</span>
    <span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Listens to 'close' event, when fired cleans up pids/</p></div></div><div class="code"><div class="wrapper">  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\nCleaning Up&#39;</span><span class="p">.</span><span class="nx">red</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="s1">&#39;pids&#39;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">unlinkSync</span><span class="p">(</span><span class="s2">&quot;pids/&quot;</span><span class="o">+</span><span class="nx">p</span><span class="p">);</span> <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Clean Up completed&#39;</span><span class="p">.</span><span class="nx">green</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;No Clean up&quot;</span><span class="p">.</span><span class="nx">yellow</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Show feedback in console</p></div></div><div class="code"><div class="wrapper"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CLUSTER_WORKER</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">umask</span><span class="p">(</span><span class="nx">oldUmask</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WORKER&#39;</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CLUSTER_WORKER</span><span class="p">);</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">connect_dbs</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;-------------------&#39;</span><span class="p">.</span><span class="nx">bold</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">.</span><span class="nx">green</span><span class="p">.</span><span class="nx">bold</span> <span class="o">+</span> <span class="s1">&#39;aa&#39;</span><span class="p">.</span><span class="nx">blue</span> <span class="o">+</span> <span class="s1">&#39;S&#39;</span><span class="p">.</span><span class="nx">green</span><span class="p">.</span><span class="nx">bold</span> <span class="o">+</span> <span class="s1">&#39;ive&#39;</span><span class="p">.</span><span class="nx">blue</span> <span class="o">+</span> <span class="s2">&quot;API&quot;</span><span class="p">.</span><span class="nx">yellow</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="nx">ENV</span><span class="p">.</span><span class="nx">bold</span><span class="p">.</span><span class="nx">green</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;API ENDPOINT SERVER&#39;</span><span class="p">.</span><span class="nx">grey</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Â© MaaSiveCO 2011&#39;</span><span class="p">.</span><span class="nx">yellow</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;-------------------&#39;</span><span class="p">.</span><span class="nx">bold</span><span class="p">);</span>
<span class="p">};</span></div></div></div></div></body></html>